# --- Options ---
# set prefix to ctrl+space
unbind C-b
set-option -g prefix C-Space
bind-key C-Space send-prefix

# Remove delay when pressing esc
set -g escape-time 0

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows on window close
set -g renumber-windows on

# When the current session is destroyed, the client is detached iff there are no detached session
set -g detach-on-destroy no-detached

# Setup true-colors
set -g default-terminal "${TERM}"
set -ga terminal-overrides ",${TERM}:Tc"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# Set terminal title to session name
set -g set-titles on
set -g set-titles-string "#(command -v whoami > /dev/null && whoami)@#H: #S - #W "

# Set main-pane height and width
set -g main-pane-height 75%
set -g main-pane-width 70%

# --- Plugins ---
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"
set -g @plugin "tmux-plugins/tmux-resurrect"
set -g @plugin "tmux-plugins/tmux-continuum"
set -g @plugin "tmux-plugins/tmux-logging"
set -g @plugin "christoomey/vim-tmux-navigator"

# --- Theme ---
source-file "~/.config/tmux/tmux.theme.conf"

# --- Keybindings ---
unbind-key ?
bind-key ? run-shell "tmux neww -n 'help'  'tmux list-keys -N | fzf'"

# Vim copy mode
set-window-option -g mode-keys vi
bind-key P paste-buffer
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi y send-keys -X copy-selection
bind-key -T copy-mode-vi r send-keys -X rectangle-toggle

# Pane manipulation
bind-key -r J resize-pane -D "2"
bind-key -r K resize-pane -U "2"
bind-key -r H resize-pane -L "10"
bind-key -r L resize-pane -R "10"
bind-key space display-panes -d 0 "swap-pane -dt %%"
bind-key j run-shell "tmux join-pane -hs :#{e|+|:#{window_index},1}"
bind-key b break-pane -a

# Window layout
bind-key -n M-enter resize-pane -Z
bind-key -n M-1 select-layout even-horizontal
bind-key -n M-2 select-layout even-vertical
bind-key -n M-3 select-layout main-horizontal
bind-key -n M-4 select-layout main-vertical

# Window manipulation
bind-key -n M-, swap-window -t -1 \; previous-window
bind-key -n M-. swap-window -t +1 \; next-window
bind c new-window -c "#{pane_current_path}"
bind-key v split-window -h -c "#{pane_current_path}"
bind-key s split-window -v -c "#{pane_current_path}"

bind-key o choose-session

# Bootstraping TPM
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

run "~/.tmux/plugins/tpm/tpm"
