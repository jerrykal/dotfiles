# --- Options ---
# set prefix to ctrl+space
unbind C-b
set-option -g prefix C-Space
bind C-Space send-prefix

# Set escape time to 50ms to allow proper OSC52 escape sequence processing
set -g escape-time 50

# Enable mouse support
set -g mouse on

# Start windows and panes at 1, not 0
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows on window close
set -g renumber-windows on

# When the current session is destroyed, the client is detached iff there are no detached session
set -g detach-on-destroy no-detached

# Allow passthrough for OSC52 clipboard sequences
set -g set-clipboard on
set -g allow-passthrough on

# Setup true-colors
set -g default-terminal "${TERM}"
set -ga terminal-overrides ",${TERM}:Tc"
set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

# Set terminal title to session name
set -g set-titles on
set -g set-titles-string "#(command -v whoami > /dev/null && whoami)@#H: #S - #W "

# Set main-pane height and width
set -g main-pane-height 75%
set -g main-pane-width 70%

# Enable extended keys support
set -g extended-keys on

# --- Keybindings ---
unbind ?
bind ? run-shell "tmux neww -n 'help'  'tmux list-keys -N | fzf'"

# Vim copy mode
set-window-option -g mode-keys vi
bind P paste-buffer
bind -T copy-mode-vi v send-keys -X begin-selection
bind -T copy-mode-vi y send-keys -X copy-selection
bind -T copy-mode-vi r send-keys -X rectangle-toggle

# Pane
bind -n M-1 select-layout even-horizontal
bind -n M-2 select-layout even-vertical
bind -n M-3 select-layout main-horizontal
bind -n M-4 select-layout main-vertical
bind space display-panes -d 0 "swap-pane -dt %%"
bind j run-shell "tmux join-pane -hs :#{e|+|:#{window_index},1}"
bind b break-pane -a

# Window
bind -n M-enter resize-pane -Z
bind -n M-, swap-window -t -1 \; previous-window
bind -n M-. swap-window -t +1 \; next-window
bind c new-window -c "#{pane_current_path}"
bind v split-window -h -c "#{pane_current_path}"
bind s split-window -v -c "#{pane_current_path}"

# Session
bind o run-shell "~/.local/bin/tmux-fzf-session"

# OpenCode
bind a run-shell "~/.local/bin/tmux-opencode #{pane_current_path}"

# --- Plugins ---
set -g @plugin "tmux-plugins/tpm"
set -g @plugin "tmux-plugins/tmux-sensible"
set -g @plugin "tmux-plugins/tmux-resurrect"
set -g @plugin "tmux-plugins/tmux-continuum"
set -g @plugin "tmux-plugins/tmux-logging"
set -g @plugin "mrjones2014/smart-splits.nvim"

# Disable wrapping
set -g @smart-splits_no_wrap 1

# Restore ctrl+h/j/k/l keys by pressing the prefix key first
bind C-h send-keys "C-h"
bind C-j send-keys "C-j"
bind C-k send-keys "C-k"
bind C-l send-keys "C-l"

# --- Theme ---
source-file "~/.config/tmux/tmux.theme.conf"

# --- TPM ---
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

run "~/.tmux/plugins/tpm/tpm"
